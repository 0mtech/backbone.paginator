/*
  backbone-pageable
  http://github.com/wyuenho/backbone-pageable

  Copyright (c) 2012 Jimmy Yuen Ho Wong
  Licensed under the MIT @license.
*/
(function(e){if("object"==typeof exports)module.exports=e(require("underscore"),require("backbone"));else if("function"==typeof define&&define.amd)define(["underscore","backbone"],e);else if("undefined"!=typeof _&&"undefined"!=typeof Backbone){var t=Backbone.PageableCollection,r=Backbone.PageableCollection=e(_,Backbone);Backbone.PageableCollection.noConflict=function(){return Backbone.PageableCollection=t,r}}})(function(e,t){"use strict";function r(t,r){if(t*=1,!e.isNumber(t)||e.isNaN(t)||!e.isFinite(t)||~~t!==t)throw new TypeError("`"+r+"` must be a finite integer");return t}function a(e){for(var t,r,a,n,o={},s=decodeURIComponent,i=e.split("&"),l=0,c=i.length;c>l;l++){var u=i[l];t=u.split("="),r=t[0],a=t[1]||!0,r=s(r),n=o[r],v(n)?n.push(a):o[r]=n?[n,a]:a}return o}function n(){var t=arguments[0],r=e.toArray(arguments).slice(1),a=t.comparator;t.comparator=null;try{t.reset.apply(t,r)}finally{t.comparator=a,a&&t.sort()}return t}var o=e.extend,s=e.omit,i=e.clone,l=e.each,c=e.pick,u=e.contains,f=e.isEmpty,g=e.pairs,d=e.invert,v=e.isArray,p=e.isFunction,P=e.keys,m=e.isUndefined,h=Math.ceil,y=t.Collection.prototype,k=/[\s'"]/g,b=/[<>\s'"]/g,_=t.Collection.extend({state:{firstPage:1,lastPage:null,currentPage:null,pageSize:25,totalPages:null,totalRecords:null,sortKey:null,order:-1},mode:"server",queryParams:{currentPage:"page",pageSize:"per_page",totalPages:"total_pages",totalRecords:"total_entries",sortKey:"sort_by",order:"order",directions:{"-1":"asc",1:"desc"}},initialize:function(e,t){t=t||{};var r=this,a=r.mode=t.mode||r.mode||S.mode,n=o({},S.queryParams,r.queryParams,t.queryParams||{});n.directions=o({},S.queryParams.directions,r.queryParams.directions,n.directions||{}),r.queryParams=n;var s=r.state=o({},S.state,r.state,t.state||{});s.currentPage=null==s.currentPage?s.firstPage:s.currentPage,"server"==a||null!=s.totalRecords||f(e)||(s.totalRecords=e.length),r.switchMode(a,o({fetch:!1,resetState:!1,models:e},t));var l=t.comparator;if(s.sortKey&&!l&&r.setSorting(s.sortKey,s.order,t),"server"!=a){if(l&&t.full){delete r.comparator;var c=r.fullCollection;c.comparator=l,c.sort()}e&&!f(e)&&(r.getPage(s.currentPage),e.splice.apply(e,[0,e.length].concat(r.models)))}r._initState=i(r.state)},_makeFullCollection:function(e,r){var a,n,o,s=this,i=["url","model","sync","comparator"],l=s.constructor.prototype,c={};for(a=0,n=i.length;n>a;a++)o=i[a],m(l[o])||(c[o]=l[o]);var u=new(t.Collection.extend(c))(e,r);for(a=0,n=i.length;n>a;a++)o=i[a],s[o]!==l[o]&&(u[o]=o);return u},_makeCollectionEventHandler:function(e,t){return function(r,a,s,c){var u=e._handlers;l(P(u),function(r){var a=u[r];e.off(r,a),t.off(r,a)});var g=i(e.state),d=g.firstPage,v=0===d?g.currentPage:g.currentPage-1,p=g.pageSize,m=v*p,y=m+p;if("add"==r){var k,b,_;if(s==t)k=t.indexOf(a),k>=m&&y>k&&(_=e,b=k-m);else{k=m+e.indexOf(a),_=t;var S=c&&c.at||k;b=m>S||S>=y?S:k}++g.totalRecords,e.state=e._checkState(g),_&&(_.add(a,o({},c||{},{at:b})),e.pop())}if("remove"==r){if(--g.totalRecords){var x=g.totalPages=h(g.totalRecords/p);g.lastPage=0===d?x-1:x,g.currentPage>x&&(g.currentPage=g.lastPage)}else g.totalRecords=null,g.totalPages=null;e.state=e._checkState(g);var C;s==e?((C=t.at(y))&&e.push(C),t.remove(a)):c.index>=m&&y>c.index&&(e.remove(a),C=t.at(v*(p+c.index)),C&&e.push(C))}if("reset"==r||"sort"==r){if(c=s,s=a,s==e&&"reset"==r){var R=t.models.slice(0,m),w=t.models.slice(m+e.models.length);c=o(c,{silent:!0}),n(t,R.concat(e.models).concat(w),c)}("reset"==r||s==t)&&((g.totalRecords=t.models.length)||(g.totalRecords=null,g.lastPage=null,g.totalPages=null),e.state=e._checkState(g),s==e&&t.trigger(r,t,c),n(e,t.models.slice(m,y),c))}l(P(u),function(r){var a=u[r];l([e,t],function(e){if(e._events){e.on(r,a);var t=e._events[r];t.unshift(t.pop())}else{var n=e._callbacks[r]||{},o=o=f(n)?n.next=n.tail={}:n.tail,s={next:n.next,context:void 0,callback:a};e._callbacks[r]={tail:o,next:s}}})})}},_checkState:function(e){var t=this,a=t.mode,n=t.links,o=e.totalRecords,s=e.pageSize,i=e.currentPage,l=e.firstPage,c=e.totalPages;if(null!=o&&null!=s&&null!=i&&null!=l&&("infinite"==a?n:!0)){if(o=r(o,"totalRecords"),s=r(s,"pageSize"),i=r(i,"currentPage"),l=r(l,"firstPage"),1>s)throw new RangeError("`pageSize` must be >= 1");if(c=e.totalPages=h(o/s),0>l||l>1)throw new RangeError("`firstPage must be 0 or 1`");if(e.lastPage=0===l?c-1:c,"infinite"==a){if(!n[i+""])throw new RangeError("No link found for page "+i)}else{if(0===l&&(l>i||i>=c))throw new RangeError("`currentPage` must be firstPage <= currentPage < totalPages if 0-based. Got "+i+".");if(1===l&&(l>i||i>c))throw new RangeError("`currentPage` must be firstPage <= currentPage <= totalPages if 1-based. Got "+i+".")}}return e},setPageSize:function(e,t){var a=this;return e=r(e,"pageSize"),t=t||{},a.state=a._checkState(o({},a.state,{pageSize:e,totalPages:h(a.state.totalRecords/e)})),a.getPage(a.state.currentPage,t)},switchMode:function(t,r){var a=this;if(!u(["server","client","infinite"],t))throw new TypeError('`mode` must be one of "server", "client" or "infinite"');r=r||{fetch:!0,resetState:!0};var n=a.state=r.resetState?i(a._initState):a._checkState(o({},a.state));a.mode=t;var c,f=a.fullCollection,g=a._handlers=a._handlers||{};if("server"==t||f)"server"==t&&f&&(l(P(g),function(e){c=g[e],a.off(e,c),f.off(e,c)}),delete a._handlers,a._fullComparator=f.comparator,delete a.fullCollection);else{f=a._makeFullCollection(r.models||[]),f.pageableCollection=a,a.fullCollection=f;var d=a._makeCollectionEventHandler(a,f);l(["add","remove","reset","sort"],function(t){g[t]=c=e.bind(d,{},t),a.on(t,c),f.on(t,c)}),f.comparator=a._fullComparator}if("infinite"==t)for(var v=a.links={},p=n.firstPage,m=h(n.totalRecords/n.pageSize),y=0===p?m-1:m||p,k=n.firstPage;y>=k;k++)v[k]=a.url;else a.links&&delete a.links;return r.fetch?a.fetch(s(r,["fetch","resetState"])):a},hasPrevious:function(){var e=this,t=e.state,r=t.currentPage;return"infinite"!=e.mode?r>t.firstPage:!!e.links[r-1]},hasNext:function(){var e=this,t=e.state,r=e.state.currentPage;return"infinite"!=e.mode?t.lastPage>r:!!e.links[r+1]},getFirstPage:function(e){return this.getPage("first",e)},getPreviousPage:function(e){return this.getPage("prev",e)},getNextPage:function(e){return this.getPage("next",e)},getLastPage:function(e){return this.getPage("last",e)},getPage:function(e,t){var a=this,i=a.mode,l=a.fullCollection;t=t||{fetch:!1};var c=a.state,u=c.firstPage,g=c.currentPage,d=c.lastPage,v=c.pageSize,p=e;switch(e){case"first":p=u;break;case"prev":p=g-1;break;case"next":p=g+1;break;case"last":p=d;break;default:p=r(e,"index")}a.state=a._checkState(o({},c,{currentPage:p}));var P=(0===u?p:p-1)*v,m=l&&l.length?l.models.slice(P,P+v):[];return"client"!=i&&("infinite"!=i||f(m))||t.fetch?("infinite"==i&&(t.url=a.links[p]),a.fetch(s(t,"fetch"))):n(a,m,s(t,"fetch"))},sync:function(e,r,a){var n=this;if("infinite"==n.mode){var s=a.success,i=n.state.currentPage;a.success=function(e,t,r){var l=n.links,c=n.parseLinks(e,o({xhr:r},a));c.first&&(l[n.state.firstPage]=c.first),c.prev&&(l[i-1]=c.prev),c.next&&(l[i+1]=c.next),s&&s(e,t,r)}}return(y.sync||t.sync).call(n,e,r,a)},parseLinks:function(t,r){var n=this,o=r.xhr.getResponseHeader("Link"),s=["first","prev","previous","next","last"],i={};l(o.split(","),function(e){var t=e.split(";"),r=t[0].replace(b,""),a=t.slice(1);l(a,function(e){var t=e.split("="),a=t[0].replace(k,""),n=t[1].replace(k,"");"rel"==a&&u(s,n)&&("previous"==n?i.prev=r:i[n]=r)})});var c,f,g=i.last||"";if(f=(c=g.indexOf("?"))?g.slice(c+1):""){var d=a(f),v=e.clone(n.state),p=n.queryParams,P=v.pageSize,m=1*d[p.totalRecords],h=1*d[p.currentPage],y=d[p.totalPages];m||(h?m=(0===v.firstPage?h+1:h)*P:y&&(m=y*P)),m&&(v.totalRecords=m),n.state=n._checkState(v)}return delete i.last,i},parse:function(t){var r=this;if(!v(t))return new TypeError("The server response must be an array");if(2===t.length&&e.isObject(t[0])&&v(t[1])){var a=r.queryParams,n=i(r.state),o=t[0];return l(g(s(a,"directions")),function(e){var t=e[0],r=e[1];n[t]=o[r]}),o.order&&(n.order=1*d(a.directions)[o.order]),r.state=r._checkState(n),t[1]}return t},fetch:function(t){var r=this;t=t||{};var l=r._checkState(r.state),u=r.mode;"infinite"!=u||t.url||(t.url=r.links[l.currentPage]);var f=t.data||{},d=t.url||e.result(r,"url")||"",v=d.indexOf("?");-1!=v&&(o(f,a(d.slice(v+1))),d=d.slice(0,v)),t.url=d,t.data=f;var h,k,b,_,x="client"==r.mode?c(r.queryParams,"sortKey","order"):s(c(r.queryParams,P(S.queryParams)),"directions"),C=g(x),R=i(r);for(h=0;C.length>h;h++)k=C[h],b=k[0],_=k[1],_=p(_)?_.call(R):_,null!=l[b]&&null!=_&&(f[_]=l[b]);l.sortKey&&l.order?f[x.order]=r.queryParams.directions[l.order+""]:l.sortKey||delete f[x.order];var w=g(s(r.queryParams,P(S.queryParams)));for(h=0;w.length>h;h++)k=w[h],_=k[1],_=p(_)?_.call(R):_,f[k[0]]=_;var q=r.fullCollection,z=r.links;if("server"!=u){var E=t.success;return t.success=function(e,r,a){a=a||{},m(t.silent)?delete a.silent:a.silent=t.silent;var s=e.models,i=l.currentPage;if("client"==u)n(q,s,a);else if(z[i]){var c=l.pageSize,f=(0===l.firstPage?i:i-1)*c,g=q.models,d=g.slice(0,f),v=g.slice(f+c);g=d.concat(s).concat(v),p(q.update)?(q.update(g,o({silent:!0,sort:!1},a)),q.comparator&&q.sort(),q.trigger("reset",q,a)):n(q,g,a)}else q.add(s,o({at:q.length,silent:!0},a)),q.trigger("reset",q,a);E&&E(e,r,a)},y.fetch.call(r,o({},t,{silent:!0}))}return y.fetch.call(r,t)},_makeComparator:function(e,t){var r=this.state;return e=e||r.sortKey,t=t||r.order,e&&t?function(r,a){var n,o=r.get(e),s=a.get(e);return 1===t&&(n=o,o=s,s=n),o===s?0:s>o?-1:1}:void 0},setSorting:function(e,t,r){var a=this,n=a.state;n.sortKey=e,n.order=t=t||n.order;var s=a.fullCollection,i=!1,l=!1;e||(i=l=!0);var c=a.mode;r=o({side:"client"==c?c:"server",full:!0},r);var u=a._makeComparator(e,t),f=r.full,g=r.side;return"client"==g?f?(s&&(s.comparator=u),i=!0):(a.comparator=u,l=!0):"server"!=g||f||(a.comparator=u),i&&delete a.comparator,l&&s&&delete s.comparator,a}}),S=_.prototype;return _});
/*
  backbone-pageable
  http://github.com/wyuenho/backbone-pageable

  Copyright (c) 2012 Jimmy Yuen Ho Wong
  Licensed under the MIT @license.
*/
(function(e){if("object"==typeof exports)module.exports=e(require("underscore"),require("backbone"));else if("function"==typeof define&&define.amd)define(["underscore","backbone"],e);else if("undefined"!=typeof _&&"undefined"!=typeof Backbone){var t=Backbone.PageableCollection,r=Backbone.PageableCollection=e(_,Backbone);Backbone.PageableCollection.noConflict=function(){return Backbone.PageableCollection=t,r}}})(function(e,t){"use strict";function r(t,r){if(!e.isNumber(t)||e.isNaN(t)||!e.isFinite(t)||~~t!==t)throw new TypeError("`"+r+"` must be a finite integer, but was '"+t+"'");return t}var i=/[\s'"]/g,a=/[<>\s'"]/g,s=t.Collection.extend({state:{firstPage:1,lastPage:null,currentPage:null,pageSize:25,totalPages:null,totalRecords:null,sortKey:null,order:-1},mode:"server",queryParams:{currentPage:"page",pageSize:"per_page",totalPages:"total_pages",totalRecords:"total_entries",sortKey:"sort_by",order:"order",directions:{"-1":"asc",1:"desc"}},initialize:function(t,r){r=r||{};var i=r.mode||this.mode||n.mode;if(!e.contains(["server","client","infinite"],i))throw new TypeError('`mode` must be one of "server", "client" or "infinite"');this.mode=i;var a=e.extend({},n.queryParams,this.queryParams,r.queryParams||{});a.directions=e.extend({},n.queryParams.directions,this.queryParams.directions,a.directions||{}),this.queryParams=a;var s=this.state=e.extend({},n.state,this.state,r.state||{});if(s.currentPage=null==s.currentPage?s.firstPage:s.currentPage,this.switchMode(i,e.extend({fetch:!1,models:t},r)),"client"==i){null!=s.totalRecords||e.isEmpty(t)||(s.totalRecords=t.length);var o=r.comparator;if(s.sortKey&&!o&&(o=this.makeComparator(s.sortKey,s.order,r)),o)if(r.full){var l=this.fullCollection;l.comparator=o,l.sort()}else this.comparator=o;t&&!e.isEmpty(t)&&(this.getPage(s.currentPage),t.splice.apply(t,[0,t.length].concat(this.models)))}this.state=this._checkState(s)},_makeFullCollection:function(r,i){var a,s,n,o=["url","model","sync","comparator"],l=this.constructor.prototype,c={};for(a=0,s=o.length;s>a;a++)n=o[a],e.isUndefined(l[n])||(c[n]=l[n]);var u=new(t.Collection.extend(c))(r,i),h=this;for(a=0,s=o.length;s>a;a++)n=o[a],h[n]!==l[n]&&(u[n]=n);return u._onFullCollectionEvent=this._onFullCollectionEvent,u.on("all",u._onFullCollectionEvent,u),u.pageableCollection=this,u},_resetQuickly:function(){var t=arguments[0],r=e.toArray(arguments).slice(1),i=t.comparator;t.comparator=null;try{t.reset.apply(t,r)}finally{t.comparator=i,i&&t.sort()}return t},_onPageableCollectionEvent:function(t,r,i,a){var s=this.fullCollection;this.off("all",this._onPageableCollectionEvent,this),s.off("all",s._onFullCollectionEvent,s);var n=this.state,o=0===n.firstPage?n.currentPage:n.currentPage-1,l=n.pageSize,c=o*l,u=c+l;if("add"==t){var h=c+this.indexOf(r);s.add(r,e.extend({},a||{},{at:h})),this.pop()}if("remove"==t){var f=s.at(u);f&&this.push(f),s.remove(r)}if("reset"==t){a=i,i=r,r=null;var g=s.models.slice(0,c),d=s.models.slice(c+this.models.length);this._resetQuickly(s,g.concat(this.models).concat(d)),this._resetQuickly(this,s.models.slice(c,u),{silent:!0})}s.on("all",s._onFullCollectionEvent,s),this.on("all",this._onPageableCollectionEvent,this)},_onFullCollectionEvent:function(t,r,i,a){var s=this.pageableCollection;this.off("all",this._onFullCollectionEvent,this),s.off("all",s._onPageableCollectionEvent,s);var n=s.state,o=0===n.firstPage?n.currentPage:n.currentPage-1,l=n.pageSize,c=o*l,u=c+l;if("add"==t){var h=this.indexOf(r);if(h>=c&&u>h){var f=h-c;s.pop(),s.add(r,e.extend({},a||{},{at:f}))}}if("remove"==t&&a.index>=c&&u>a.index){s.remove(r);var g=this.at(u);g&&s.push(g)}if("reset"==t||"sort"==t){if(a=i,i=r,"client"==s.mode){var d=e.extend({},n,{lastPage:null,totalPages:null,totalRecords:this.models.length});s.state=s._checkState(d)}s._resetQuickly(s,this.models.slice(c,u),a)}s.on("all",s._onPageableCollectionEvent,s),this.on("all",this._onFullCollectionEvent,this)},_checkState:function(e){var t=e.totalRecords,i=e.pageSize,a=e.currentPage,s=e.firstPage,n=e.totalPages;if(null!=t&&null!=i&&null!=a&&null!=s){if(r(t,"totalRecords"),r(i,"pageSize"),r(a,"currentPage"),r(s,"firstPage"),1>i||i>t)throw new RangeError("`pageSize` must be 1 <= pageSize <= totalRecords");if(null==n&&(n=e.totalPages=Math.ceil(t/i)),0===s){if(s>a||a>=n)throw new RangeError("`currentPage` must be firstPage <= currentPage < totalPages if 0-based.")}else{if(1!==s)throw new RangeError("`firstPage must be 0 or 1`");if(s>a||a>n)throw new RangeError("`currentPage` must be firstPage <= currentPage <= totalPages if 1-based.")}e.lastPage=0===s?n-1:n}return e},setPageSize:function(t,i){return r(t,"pageSize"),i=i||{},this.state=this._checkState(e.extend({},this.state,{pageSize:t,totalPages:"client"==this.mode?Math.ceil(this.fullCollection.size()/t):Math.ceil(this.state.totalRecords/t)})),this.getPage(this.state.currentPage,i)},switchMode:function(t,r){r=r||{};var i;return this.state=this._checkState(e.extend({},this.state)),"client"==t?(this.links&&delete this.links,i=this.fullCollection=this._makeFullCollection(r.models||[]),i.comparator=this._fullComparator,this.on("all",this._onPageableCollectionEvent,this)):this.fullCollection&&(i=this.fullCollection,i.off("all",i._onFullCollectionEvent,i),this.off("all",this._onPageableCollectionEvent,this),this._fullComparator=i.comparator,delete this.fullCollection,"server"==t&&this.links&&delete this.links),"infinite"==t&&(this.links={first:this.url}),null==r.fetch||r.fetch?this.fetch(r):this},getFirstPage:function(e){return this.getPage("first",e)},getPreviousPage:function(e){return this.getPage("prev",e)},getNextPage:function(e){return this.getPage("next",e)},getLastPage:function(e){return this.getPage("last",e)},getPage:function(t,i){i=i||{fetch:!1};var a=this,s=this.links;if("infinite"==this.mode){if(!s[t])throw new TypeError("No link found for '"+t+"'");return this.fetch(e.extend({url:this.links[t]},i)).done(function(e,t,r){a.links=a.parseLinks(e,r)})}var n=this.state,o=n.firstPage,l=n.currentPage,c=n.lastPage,u=n.pageSize;switch(t){case"first":t=o;break;case"prev":t=l-1;break;case"next":t=l+1;break;case"last":t=c;break;default:r(t,"index")}if(this.state=this._checkState(e.extend({},n,{currentPage:t})),"client"==this.mode&&!i.fetch){var h=(0===o?t:t-1)*u,f=h+u;return this.reset(this.fullCollection.models.slice(h,f))}return this.fetch(i,"fetch")},parseLinks:function(t,r){var s=r.getResponseHeader("Link"),n=["first","prev","previous","next","last"],o={};return e.each(s.split(","),function(t){var r=t.split(";"),s=r[0].replace(a,""),l=r.slice(1);e.each(l,function(t){var r=t.split("="),a=r[0].replace(i,""),l=r[1].replace(i,"");"rel"==a&&e.contains(n,l)&&("previous"==l?o.prev=s:o[l]=s)})}),o},parse:function(t){if(!e.isArray(t))return new TypeError("The server response must be an array");if(2===t.length&&e.isObject(t[0])&&e.isArray(t[1])){var r=this.queryParams,i=e.clone(this.state),a=t[0];return e.each(e.pairs(e.omit(r,"directions")),function(e){var t=e[0],r=e[1];i[t]=a[r]}),a.order&&(i.order=1*e.invert(r.directions)[a.order]),this.state=this._checkState(i),t[1]}return t},fetch:function(r){r=r||{};var i=r.data=r.data||{},a=this.state;this._checkState(a);var s,o,l,c,u="client"==this.mode?e.pick(this.queryParams,"sortKey","order"):e.omit(e.pick(this.queryParams,e.keys(n.queryParams)),"directions"),h=e.pairs(u),f=e.clone(this);for(s=0;h.length>s;s++)o=h[s],l=o[0],c=o[1],c=e.isFunction(c)?c.call(f):c,null!=a[l]&&null!=c&&(i[c]=a[l]);a.sortKey&&a.order?i[u.order]=this.queryParams.directions[a.order+""]:a.sortKey||delete i[u.order];var g=e.pairs(e.omit(this.queryParams,e.keys(n.queryParams)));for(s=0;g.length>s;s++)o=g[s],c=o[1],c=e.isFunction(c)?c.call(f):c,i[o[0]]=c;var d=t.Collection.prototype;if("client"==this.mode){var p=this,P=r.success;return r.success=function(e,t,i){i=i||{},i.silent=r.silent,p.fullCollection.reset(e.models,i),P&&P(e,t,i)},d.fetch.call(this,e.extend({},r,{silent:!0}))}return d.fetch.call(this,r)},makeComparator:function(e,t){if(e=null==e?this.state.sortKey:e,t=null==t?this.state.order:t,e&&t){var r=function(r,i){var a,s=r.get(e),n=i.get(e);return 1===t&&(a=s,s=n,n=a),s===n?0:n>s?-1:1};return r}}}),n=s.prototype;return s});
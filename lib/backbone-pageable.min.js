/*
  backbone-pageable
  http://github.com/wyuenho/backbone-pageable

  Copyright (c) 2012 Jimmy Yuen Ho Wong
  Licensed under the MIT @license.
*/
(function(e){if("object"==typeof exports)module.exports=e(require("underscore"),require("backbone"));else if("function"==typeof define&&define.amd)define(["underscore","backbone"],e);else if("undefined"!=typeof _&&"undefined"!=typeof Backbone){var t=Backbone.PageableCollection,i=Backbone.PageableCollection=e(_,Backbone);Backbone.PageableCollection.noConflict=function(){return Backbone.PageableCollection=t,i}}})(function(e,t){"use strict";var i=t.Collection.extend({state:{firstPage:1,lastPage:null,currentPage:1,pageSize:25,totalPages:null,totalRecords:null,sortKey:null,order:-1,isClientMode:!1},queryParams:{currentPage:"page",pageSize:"per_page",totalPages:"total_pages",totalRecords:"total",sortKey:"sort_by",order:"order",directions:{"-1":"ASC",1:"DESC"}},fullCollection:void 0,initialize:function(t,i){t=t||[],i=i||{};var r=e.extend({},this.queryParams,i.queryParams||{});r.directions=e.extend({},this.queryParams.directions,r.directions||{}),this.queryParams=r;var a=this.state=e.extend({},this.state,i.state||{});a.isClientMode&&(this.fullCollection=this._makeFullCollection(t,e.omit(i,"comparator")),i.full&&e.isFunction(i.comparator)&&(this.fullCollection.comparator=i.comparator),this.on("all",this._onPageableCollectionEvent,this.fullCollection),this._definedAndNotNull(a.totalRecords)||(a.totalRecords=t.length)),e.isString(a.sortKey)&&!e.isFunction(i.comparator)&&this.setComparator(a.sortKey,a.order,i),this.state=this._checkState(a),a.isClientMode&&this.getPage(this.state.currentPage)},_makeFullCollection:function(i,r){i=i.slice();for(var a=0,s=i[a];i.length>a;a++)i[a]=s instanceof t.Model?s.attributes:e.clone(s);r=r||{};var n=new(t.Collection.extend({model:this.model,url:this.url,sync:this.sync}))(i,e.omit(r,"state","queryParams"));return n.pageableCollection=this,n.on("all",this._onFullCollectionEvent,this),n},_onPageableCollectionEvent:function(t,i,r,a){r.off("all",r._onFullCollectionEvent,r);var s=r.state,n=0===s.firstStart?s.currentPage:s.currentPage-1,o=s.pageSize,l=n*o;if("add"===t||"remove"===t){var c=l+a.index;this[t](i,e.extend({},a,{at:c}))}if("reset"===t&&(a=r,r=i,i=null,r.length!==o)){var h=r.toArray(),u=this.toArray(),d=e.difference(u,h),g=e.difference(h,u);this.add(d),this.remove(g)}var f;"change"===t&&(f=this.getByCid(i.cid))&&(a=r,r=null,f.set(a.changes,a)),"sync"===t&&(f=this.get(i.cid))&&f.fetch(),r.on("all",r._onFullCollectionEvent,r)},_onFullCollectionEvent:function(t,i,r,a){r.off("all",this._onPageableCollectionEvent,r);var s=this.state,n=0===s.firstPage?s.currentPage:s.currentPage-1,o=s.pageSize,l=n*o,c=l+o;if(("add"===t||"remove"===t)&&a.index>=l&&c>a.index){var h=a.index-l;this[t](i,e.extend({},a,{at:h}))}"reset"===t&&(a=r,r=i,this.reset(r.toArray().slice(l,c),a));var u;"change"===t&&(u=this.getByCid(i.cid))&&(a=r,r=null,u.set(a.changes,a)),"sync"===t&&(u=this.get(i.cid))&&u.fetch(),r.on("all",this._onPageableCollectionEvent,r)},_typeCheckInt:function(t,i){if(!e.isNumber(t)||e.isNaN(t)||!e.isFinite(t)||~~t!==t)throw new TypeError("`"+i+"` must be a finite integer")},_definedAndNotNull:function(t){return!e.isUndefined(t)&&null!==t},_checkState:function(t){if(this._definedAndNotNull(t.totalRecords)&&this._definedAndNotNull(t.pageSize)&&this._definedAndNotNull(t.currentPage)&&this._definedAndNotNull(t.firstPage)){if(this._typeCheckInt(t.totalRecords,"totalRecords"),this._typeCheckInt(t.pageSize,"pageSize"),this._typeCheckInt(t.currentPage,"currentPage"),this._typeCheckInt(t.firstPage,"firstPage"),1>t.pageSize||t.pageSize>t.totalRecords)throw new RangeError("`pageSize` must be 1 <= pageSize <= totalRecords");if((e.isUndefined(t.totalPages)||null===t.totalPages)&&(t.totalPages=t.totalRecords/t.pageSize),0===t.firstPage){if(t.currentPage<t.firstPage||t.currentPage>=t.totalPages)throw new RangeError("`currentPage` must be firstPage <= currentPage < totalPages if 0-based.")}else{if(1!==t.firstPage)throw new RangeError("`firstPage must be 0 or 1`");if(t.currentPage<t.firstPage||t.currentPage>t.totalPages)throw new RangeError("`currentPage` must be firstPage <= currentPage <= totalPages if 1-based.")}t.lastPage=0===t.firstPage?t.totalPages-1:t.totalPages}return t},setPageSize:function(t,i){return this._typeCheckInt(t,"pageSize"),i=i||{},this.state=this._checkState(e.extend({},this.state,{pageSize:t,totalPages:this.state.isClientMode?Math.ceil(this.fullCollection.size()/t):this.state.totalRecords/t})),this.getPage(this.state.currentPage,i)},switchMode:function(e){return(this.state.isClientMode=!this.state.isClientMode)||(this.off(null,null,this.fullCollection),this.fullCollection.reset()),e&&this._definedAndNotNull(e.fetch)&&!e.fetch?this:this.fetch(e)},getFirstPage:function(e){return this.getPage(this.state.firstPage,e)},getPreviousPage:function(e){return this.getPage(this.state.currentPage-1,e)},getNextPage:function(e){return this.getPage(this.state.currentPage+1,e)},getLastPage:function(e){return this.getPage(this.state.lastPage,e)},getPage:function(t,i){if(this._typeCheckInt(t,"index"),this.state.firstPage>t||t>this.state.lastPage)throw new RangeError("`index` must be firstPage <= index <= lastPage");i=i||{fetch:!1};var r=this.state=this._checkState(e.extend({},this.state,{currentPage:t}));if(r.isClientMode&&!i.fetch){var a=(0===r.firstPage?r.currentPage:r.currentPage-1)*r.pageSize,s=a+r.perPage;return this.reset(this.fullCollection.toArray().slice(a,s))}return this.fetch(e.omit(i,"fetch"))},parse:function(t){if(!e.isArray(t))return new TypeError("The server response must be an array");if(2===t.length&&e.isObject(t[0])&&e.isArray(t[1])){var i=e.clone(this.state),r=t[0];return e.each(e.pairs(e.omit(this.queryParams,"directions")),function(e){var t=e[0],a=e[1];i[t]=r[a]}),this._definedAndNotNull(r.order)&&(i.order=1*e.invert(this.queryParams.directions)[r.order]),this.state=this._checkState(i),t[1]}return t},fetch:function(i){i=i||{};var r=i.data=i.data||{},a=this,s=this.state;this._checkState(s);var n=s.isClientMode?e.pick(this.queryParams,"sortKey","order","directions"):this.queryParams;e.each(e.pairs(e.omit(n,"directions")),function(e){var t=e[0],i=e[1];a._definedAndNotNull(s[t])&&(r[i]=s[t])}),s.order?r[n.order]=n.directions[s.order+""]:delete r[n.order];var o=t.Collection.prototype;if(s.isClientMode){var l=i.success;return i.success=function(e,t,r){r.silent=i.silent,this.fullCollection.reset(e.models,r),l&&l(e,t,r)},o.fetch.call(this,e.extend({},i,{silent:!0}))}return o.fetch.call(this,i)},setComparator:function(t,i,r){if(t=e.isUndefined(t)?this.state.sortKey:t,i=e.isUndefined(i)?this.state.order:i,r=r||{},this.state.sortKey=t,this.state.order=i,!t||!i)return this;var a=function(e,r){var a,s=e.get(t),n=r.get(t);return 1===i&&(a=s,s=n,n=a),s===n?0:n>s?-1:1};return this.state.isClientMode&&r.full?this.fullCollection.comparator=a:this.comparator=a,this}});return i});
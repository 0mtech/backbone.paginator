/*
  backbone-pageable
  http://github.com/wyuenho/backbone-pageable

  Copyright (c) 2012 Jimmy Yuen Ho Wong
  Licensed under the MIT @license.
*/
(function(e){if("object"==typeof exports)module.exports=e(require("underscore"),require("backbone"));else if("function"==typeof define&&define.amd)define(["underscore","backbone"],e);else if("undefined"!=typeof _&&"undefined"!=typeof Backbone){var t=Backbone.PageableCollection,r=Backbone.PageableCollection=e(_,Backbone);Backbone.PageableCollection.noConflict=function(){return Backbone.PageableCollection=t,r}}})(function(e,t){"use strict";function r(t,r){if(t*=1,!e.isNumber(t)||e.isNaN(t)||!e.isFinite(t)||~~t!==t)throw new TypeError("`"+r+"` must be a finite integer");return t}function a(e){for(var t,r,a,s,i={},n=decodeURIComponent,o=e.split("&"),l=0,c=o.length;c>l;l++){var u=o[l];t=u.split("="),r=t[0],a=t[1]||!0,r=n(r),s=i[r],d(s)?s.push(a):i[r]=s?[s,a]:a}return i}function s(){var t=arguments[0],r=e.toArray(arguments).slice(1),a=t.comparator;t.comparator=null;try{t.reset.apply(t,r)}finally{t.comparator=a,a&&t.sort()}return t}var i=e.extend,n=e.omit,o=e.clone,l=e.each,c=e.pick,u=e.contains,h=e.isEmpty,f=e.pairs,g=e.invert,d=e.isArray,P=e.isFunction,p=e.keys,m=Math.ceil,v=t.Collection.prototype,y=/[\s'"]/g,k=/[<>\s'"]/g,b=t.Collection.extend({state:{firstPage:1,lastPage:null,currentPage:null,pageSize:25,totalPages:null,totalRecords:null,sortKey:null,order:-1},mode:"server",queryParams:{currentPage:"page",pageSize:"per_page",totalPages:"total_pages",totalRecords:"total_entries",sortKey:"sort_by",order:"order",directions:{"-1":"asc",1:"desc"}},initialize:function(e,t){t=t||{};var r=this.mode=t.mode||this.mode||S.mode,a=i({},S.queryParams,this.queryParams,t.queryParams||{});a.directions=i({},S.queryParams.directions,this.queryParams.directions,a.directions||{}),this.queryParams=a;var s=this.state=i({},S.state,this.state,t.state||{});s.currentPage=null==s.currentPage?s.firstPage:s.currentPage,"server"==r||null!=s.totalRecords||h(e)||(s.totalRecords=e.length),this.switchMode(r,i({fetch:!1,resetState:!1,models:e},t));var n=t.comparator;if(s.sortKey&&!n&&this.setSorting(s.sortKey,s.order,t),"server"!=r){if(n&&t.full){delete this.comparator;var l=this.fullCollection;l.comparator=n,l.sort()}e&&!h(e)&&(this.getPage(s.currentPage),e.splice.apply(e,[0,e.length].concat(this.models)))}this._initState=o(this.state)},_makeFullCollection:function(r,a){var s,i,n,o=["url","model","sync","comparator"],l=this.constructor.prototype,c={};for(s=0,i=o.length;i>s;s++)n=o[s],e.isUndefined(l[n])||(c[n]=l[n]);var u=new(t.Collection.extend(c))(r,a);for(s=0,i=o.length;i>s;s++)n=o[s],this[n]!==l[n]&&(u[n]=n);return u},_makeCollectionEventHandler:function(e,t){return function r(a,n,l,c){e.off("all",r),t.off("all",r);var u=o(e.state),h=u.firstPage,f=0===h?u.currentPage:u.currentPage-1,g=u.pageSize,d=f*g,P=d+g;if("add"==a){var p,v,y;if(l==t)p=t.indexOf(n),p>=d&&P>p&&(y=e,v=p-d);else{p=d+e.indexOf(n),y=t;var k=c&&c.at||p;v=d>k||k>=P?k:p}y&&(y.add(n,i({},c||{},{at:v})),e.pop()),u.totalRecords++}if("remove"==a){var b;if(l==e?(b=t.at(P),b&&e.push(b),t.remove(n)):c.index>=d&&P>c.index&&(e.remove(n),b=t.at(f*(g+c.index)),b&&e.push(b)),--u.totalRecords){var S=u.totalPages=m(u.totalRecords/g);u.lastPage=0===h?S-1:S,u.currentPage>S&&(u.currentPage=u.lastPage)}else u.totalRecords=null,u.totalPages=null}if("reset"==a||"sort"==a){if(c=l,l=n,l==e&&"reset"==a){var _=t.models.slice(0,d),C=t.models.slice(d+e.models.length);s(t,_.concat(e.models).concat(C)),c=i(c,{silent:!0})}l==t&&(s(e,t.models.slice(d,P),c),u.totalRecords=t.models.length)}e.state=e._checkState(u),e.on("all",r),t.on("all",r)}},_checkState:function(e){var t=this.mode,a=this.links,s=e.totalRecords,i=e.pageSize,n=e.currentPage,o=e.firstPage,l=e.totalPages;if(null!=s&&null!=i&&null!=n&&null!=o&&("infinite"==t?a:!0)){if(s=r(s,"totalRecords"),i=r(i,"pageSize"),n=r(n,"currentPage"),o=r(o,"firstPage"),1>i)throw new RangeError("`pageSize` must be >= 1");if(l=e.totalPages=m(s/i),0>o||o>1)throw new RangeError("`firstPage must be 0 or 1`");if(e.lastPage=0===o?l-1:l,"infinite"==t){if(!a[n+""])throw new RangeError("No link found for page "+n)}else{if(0===o&&(o>n||n>=l))throw new RangeError("`currentPage` must be firstPage <= currentPage < totalPages if 0-based. Got "+n+".");if(1===o&&(o>n||n>l))throw new RangeError("`currentPage` must be firstPage <= currentPage <= totalPages if 1-based. Got "+n+".")}}return e},setPageSize:function(e,t){return e=r(e,"pageSize"),t=t||{},this.state=this._checkState(i({},this.state,{pageSize:e,totalPages:m(this.state.totalRecords/e)})),this.getPage(this.state.currentPage,t)},switchMode:function(e,t){if(!u(["server","client","infinite"],e))throw new TypeError('`mode` must be one of "server", "client" or "infinite"');t=t||{fetch:!0,resetState:!0};var r=this.state=t.resetState?o(this._initState):this._checkState(i({},this.state));this.mode=e;var a=this.fullCollection,s=this._eh;if("server"==e||a?"server"==e&&a&&(a.off("all",s),this.off("all",s),this._fullComparator=a.comparator,delete this.fullCollection):(a=this.fullCollection=this._makeFullCollection(t.models||[]),s=this._eh=this._makeCollectionEventHandler(this,a),a.on("all",s),this.on("all",s),a.comparator=this._fullComparator),"infinite"==e)for(var l=this.links={},c=r.firstPage,h=m(r.totalRecords/r.pageSize),f=0===c?h-1:h||c,g=r.firstPage;f>=g;g++)l[g]=this.url;else this.links&&delete this.links;return t.fetch?this.fetch(n(t,["fetch","resetState"])):this},hasPrevious:function(){var e=this.state,t=e.currentPage;return"infinite"!=this.mode?t>=e.firstPage:!!this.links[t-1]},hasNext:function(){var e=this.state,t=this.state.currentPage;return"infinite"!=this.mode?e.lastPage>=t:!!this.links[t+1]},getFirstPage:function(e){return this.getPage("first",e)},getPreviousPage:function(e){return this.getPage("prev",e)},getNextPage:function(e){return this.getPage("next",e)},getLastPage:function(e){return this.getPage("last",e)},getPage:function(e,t){var a=this.mode,o=this.fullCollection;t=t||{fetch:!1};var l=this.state,c=l.firstPage,u=l.currentPage,f=l.lastPage,g=l.pageSize,d=e;switch(e){case"first":d=c;break;case"prev":d=u-1;break;case"next":d=u+1;break;case"last":d=f;break;default:d=r(e,"index")}this.state=this._checkState(i({},l,{currentPage:d}));var P=(0===c?d:d-1)*g,p=o&&o.length?o.models.slice(P,P+g):[];return"client"!=a&&("infinite"!=a||h(p))||t.fetch?("infinite"==a&&(t.url=this.links[d]),this.fetch(n(t,"fetch"))):s(this,p,n(t,"fetch"))},sync:function(e,r,a){if("infinite"==this.mode){var s=a.success,n=this,o=this.state.currentPage;a.success=function(e,t,r){var l=n.links,c=n.parseLinks(e,i({xhr:r},a));c.first&&(l[n.state.firstPage]=c.first),c.prev&&(l[o-1]=c.prev),c.next&&(l[o+1]=c.next),s&&s(e,t,r)}}return(v.sync||t.sync).call(this,e,r,a)},parseLinks:function(t,r){var s=r.xhr.getResponseHeader("Link"),i=["first","prev","previous","next","last"],n={};l(s.split(","),function(e){var t=e.split(";"),r=t[0].replace(k,""),a=t.slice(1);l(a,function(e){var t=e.split("="),a=t[0].replace(y,""),s=t[1].replace(y,"");"rel"==a&&u(i,s)&&("previous"==s?n.prev=r:n[s]=r)})});var o,c,h=n.last||"";if(c=(o=h.indexOf("?"))?h.slice(o+1):""){var f=a(c),g=e.clone(this.state),d=this.queryParams,P=g.pageSize,p=1*f[d.totalRecords],m=1*f[d.currentPage],v=f[d.totalPages];p||(m?p=(0===g.firstPage?m+1:m)*P:v&&(p=v*P)),p&&(g.totalRecords=p),this.state=this._checkState(g)}return delete n.last,n},parse:function(t){if(!d(t))return new TypeError("The server response must be an array");if(2===t.length&&e.isObject(t[0])&&d(t[1])){var r=this.queryParams,a=o(this.state),s=t[0];return l(f(n(r,"directions")),function(e){var t=e[0],r=e[1];a[t]=s[r]}),s.order&&(a.order=1*g(r.directions)[s.order]),this.state=this._checkState(a),t[1]}return t},fetch:function(e){e=e||{};var t=this._checkState(this.state),r=this.mode;"infinite"!=r||e.url||(e.url=this.links[t.currentPage]);var l=e.data||{},u=e.url||this.url||"",h=u.indexOf("?");-1!=h&&(i(l,a(u.slice(h+1))),u=u.slice(0,h)),e.url=u,e.data=l;var g,d,m,y,k="client"==this.mode?c(this.queryParams,"sortKey","order"):n(c(this.queryParams,p(S.queryParams)),"directions"),b=f(k),_=o(this);for(g=0;b.length>g;g++)d=b[g],m=d[0],y=d[1],y=P(y)?y.call(_):y,null!=t[m]&&null!=y&&(l[y]=t[m]);t.sortKey&&t.order?l[k.order]=this.queryParams.directions[t.order+""]:t.sortKey||delete l[k.order];var C=f(n(this.queryParams,p(S.queryParams)));for(g=0;C.length>g;g++)d=C[g],y=d[1],y=P(y)?y.call(_):y,l[d[0]]=y;var x=this.fullCollection,R=this.links;if("server"!=r){var w=e.success;return e.success=function(a,n,o){o=o||{},o.silent=e.silent;var l=a.models,c=t.currentPage;if("client"==r)s(x,l,o);else if(R[c]){var u=t.pageSize,h=(0===t.firstPage?c:c-1)*u,f=x.models,g=f.slice(0,h),d=f.slice(h+u);f=g.concat(l).concat(d),P(x.update)?(x.update(f,i({silent:!0,sort:!1},o)),x.comparator&&x.sort(),x.trigger("reset",x,o)):s(x,f,o)}else x.add(l,i({at:x.length,silent:!0},o)),x.trigger("reset",x,o);w&&w(a,n,o)},v.fetch.call(this,i({},e,{silent:!0}))}return v.fetch.call(this,e)},_makeComparator:function(e,t){var r=this.state;return e=e||r.sortKey,t=t||r.order,e&&t?function(r,a){var s,i=r.get(e),n=a.get(e);return 1===t&&(s=i,i=n,n=s),i===n?0:n>i?-1:1}:void 0},setSorting:function(e,t,r){var a=this.state;a.sortKey=e,a.order=t=t||a.order;var s=this.fullCollection,n=!1,o=!1;e||(n=o=!0);var l=this.mode;r=i({side:"client"==l?l:"server",full:!0},r);var c=this._makeComparator(e,t),u=r.full,h=r.side;return"client"==h?u?(s&&(s.comparator=c),n=!0):(this.comparator=c,o=!0):"server"!=h||u||(this.comparator=c),n&&delete this.comparator,o&&s&&delete s.comparator,this}}),S=b.prototype;return b});
/*
  backbone-pageable
  http://github.com/wyuenho/backbone-pageable

  Copyright (c) 2012 Jimmy Yuen Ho Wong
  Licensed under the MIT @license.
*/
(function(e){if("object"==typeof exports)module.exports=e(require("underscore"),require("backbone"));else if("function"==typeof define&&define.amd)define(["underscore","backbone"],e);else if("undefined"!=typeof _&&"undefined"!=typeof Backbone){var t=Backbone.PageableCollection,i=Backbone.PageableCollection=e(_,Backbone);Backbone.PageableCollection.noConflict=function(){return Backbone.PageableCollection=t,i}}})(function(e,t){"use strict";var i=t.Collection.extend({state:{firstPage:1,lastPage:null,currentPage:null,pageSize:25,totalPages:null,totalRecords:null,sortKey:null,order:-1,isClientMode:!1},queryParams:{currentPage:"page",pageSize:"per_page",totalPages:"total_pages",totalRecords:"total",sortKey:"sort_by",order:"order",directions:{"-1":"ASC",1:"DESC"}},fullCollection:void 0,initialize:function(t,a){a=a||{};var r=i.prototype,o=e.extend({},r.queryParams,this.queryParams,a.queryParams||{});o.directions=e.extend({},r.queryParams.directions,this.queryParams.directions,o.directions||{}),this.queryParams=o;var s=this.state=e.extend({},r.state,this.state,a.state||{});if(s.currentPage=this._definedAndNotNull(s.currentPage)?s.currentPage:s.firstPage,s.isClientMode){this._definedAndNotNull(s.totalRecords)||!t||e.isEmpty(t)||(s.totalRecords=t.length),this.state=this._checkState(s);var n=this.fullCollection=this._makeFullCollection(t,e.omit(a,"comparator","state","queryParams")),l=a.comparator;e.isString(s.sortKey)&&!e.isFunction(l)&&(l=this.makeComparator(s.sortKey,s.order,a)),a.full?(n.comparator=l,n.sort()):this.comparator=l,t&&!e.isEmpty(t)&&(this.getPage(s.currentPage),t.splice.apply(t,[0,t.length].concat(this.models))),this.on("all",this._onPageableCollectionEvent,this)}else this.state=this._checkState(s)},_makeFullCollection:function(i,a){var r,o,s,n=["url","model","sync","comparator"],l=this.constructor.prototype,c={};for(r=0,o=n.length;o>r;r++)s=n[r],e.isUndefined(l[s])||(c[s]=l[s]);var h=new(t.Collection.extend(c))(i,a),u=this;for(r=0,o=n.length;o>r;r++)s=n[r],u[s]!==l[s]&&(h[s]=s);return h._onFullCollectionEvent=this._onFullCollectionEvent,h.on("all",h._onFullCollectionEvent,h),h.pageableCollection=this,h},_resetQuickly:function(){var t=arguments[0],i=e.toArray(arguments).slice(1),a=t.comparator;t.comparator=null;try{t.reset.apply(t,i)}finally{t.comparator=a,a&&t.sort()}return t},_onPageableCollectionEvent:function(t,i,a,r){var o=this.fullCollection;this.off("all",this._onPageableCollectionEvent,this),o.off("all",o._onFullCollectionEvent,o);var s=this.state,n=0===s.firstPage?s.currentPage:s.currentPage-1,l=s.pageSize,c=n*l,h=c+l;if("add"===t){var u=c+this.indexOf(i);o.add(i,e.extend({},r||{},{at:u})),this.pop()}if("remove"===t){var d=o.at(h);d&&this.push(d),o.remove(i)}if("reset"===t){r=a,a=i,i=null;var g=o.models.slice(0,c),f=o.models.slice(c+this.models.length);this._resetQuickly(o,g.concat(this.models).concat(f)),this._resetQuickly(this,o.models.slice(c,h),{silent:!0})}o.on("all",o._onFullCollectionEvent,o),this.on("all",this._onPageableCollectionEvent,this)},_onFullCollectionEvent:function(t,i,a,r){var o=this.pageableCollection;this.off("all",this._onFullCollectionEvent,this),o.off("all",o._onPageableCollectionEvent,o);var s=o.state,n=0===s.firstPage?s.currentPage:s.currentPage-1,l=s.pageSize,c=n*l,h=c+l;if("add"===t){var u=this.indexOf(i);if(u>=c&&h>u){var d=u-c;o.pop(),o.add(i,e.extend({},r||{},{at:d}))}}if("remove"===t&&r.index>=c&&h>r.index){o.remove(i);var g=this.at(h);g&&o.push(g)}if("reset"===t||"sort"===t){if(r=a,a=i,s.isClientMode){var f=e.extend({},s,{lastPage:null,totalPages:null,totalRecords:this.models.length});o.state=o._checkState(f)}o._resetQuickly(o,this.models.slice(c,h),r)}o.on("all",o._onPageableCollectionEvent,o),this.on("all",this._onFullCollectionEvent,this)},_typeCheckInt:function(t,i){if(!e.isNumber(t)||e.isNaN(t)||!e.isFinite(t)||~~t!==t)throw new TypeError("`"+i+"` must be a finite integer")},_definedAndNotNull:function(t){return!e.isUndefined(t)&&null!==t},_checkState:function(t){if(this._definedAndNotNull(t.totalRecords)&&this._definedAndNotNull(t.pageSize)&&this._definedAndNotNull(t.currentPage)&&this._definedAndNotNull(t.firstPage)){if(this._typeCheckInt(t.totalRecords,"totalRecords"),this._typeCheckInt(t.pageSize,"pageSize"),this._typeCheckInt(t.currentPage,"currentPage"),this._typeCheckInt(t.firstPage,"firstPage"),1>t.pageSize||t.pageSize>t.totalRecords)throw new RangeError("`pageSize` must be 1 <= pageSize <= totalRecords");if((e.isUndefined(t.totalPages)||null===t.totalPages)&&(t.totalPages=Math.ceil(t.totalRecords/t.pageSize)),0===t.firstPage){if(t.currentPage<t.firstPage||t.currentPage>=t.totalPages)throw new RangeError("`currentPage` must be firstPage <= currentPage < totalPages if 0-based.")}else{if(1!==t.firstPage)throw new RangeError("`firstPage must be 0 or 1`");if(t.currentPage<t.firstPage||t.currentPage>t.totalPages)throw new RangeError("`currentPage` must be firstPage <= currentPage <= totalPages if 1-based.")}t.lastPage=0===t.firstPage?t.totalPages-1:t.totalPages}return t},setPageSize:function(t,i){return this._typeCheckInt(t,"pageSize"),i=i||{},this.state=this._checkState(e.extend({},this.state,{pageSize:t,totalPages:this.state.isClientMode?Math.ceil(this.fullCollection.size()/t):Math.ceil(this.state.totalRecords/t)})),this.getPage(this.state.currentPage,i)},switchMode:function(t){var i;return(this.state.isClientMode=!this.state.isClientMode)?(i=this.fullCollection=this._makeFullCollection([]),i.comparator=this._fullComparator,this.on("all",this._onPageableCollectionEvent,this)):(i=this.fullCollection,i.off("all",i._onFullCollectionEvent,i),this.off("all",this._onPageableCollectionEvent,this),this._fullComparator=i.comparator,delete this.fullCollection),t&&e.isBoolean(t.fetch)&&!t.fetch?this:this.fetch(t)},getFirstPage:function(e){return this.getPage(this.state.firstPage,e)},getPreviousPage:function(e){return this.getPage(this.state.currentPage-1,e)},getNextPage:function(e){return this.getPage(this.state.currentPage+1,e)},getLastPage:function(e){return this.getPage(this.state.lastPage,e)},getPage:function(t,i){if(this._typeCheckInt(t,"index"),this.state.firstPage>t||t>this.state.lastPage)throw new RangeError("`index` must be firstPage <= index <= lastPage");i=i||{fetch:!1};var a=this.state=this._checkState(e.extend({},this.state,{currentPage:t}));if(a.isClientMode&&!i.fetch){var r=(0===a.firstPage?a.currentPage:a.currentPage-1)*a.pageSize,o=r+a.pageSize;return this.reset(this.fullCollection.models.slice(r,o))}return this.fetch(e.omit(i,"fetch"))},parse:function(t){if(!e.isArray(t))return new TypeError("The server response must be an array");if(2===t.length&&e.isObject(t[0])&&e.isArray(t[1])){var i=e.clone(this.state),a=t[0];return e.each(e.pairs(e.omit(this.queryParams,"directions")),function(e){var t=e[0],r=e[1];i[t]=a[r]}),this._definedAndNotNull(a.order)&&(i.order=1*e.invert(this.queryParams.directions)[a.order]),this.state=this._checkState(i),t[1]}return t},fetch:function(i){i=i||{};var a=i.data=i.data||{},r=this,o=this.state;this._checkState(o);var s=o.isClientMode?e.pick(this.queryParams,"sortKey","order","directions"):this.queryParams;e.each(e.pairs(e.omit(s,"directions")),function(e){var t=e[0],i=e[1];r._definedAndNotNull(o[t])&&(a[i]=o[t])}),o.sortKey?o.order?a[s.order]=s.directions[o.order+""]:delete a[s.order]:o.sortKey||(delete a[s.sortKey],delete a[s.order]);var n=t.Collection.prototype;if(o.isClientMode){var l=i.success;return i.success=function(e,t,a){a=a||{},a.silent=i.silent,r.fullCollection.reset(e.models,a),l&&l(e,t,a)},n.fetch.call(this,e.extend({},i,{silent:!0}))}return n.fetch.call(this,i)},makeComparator:function(t,i){if(t=e.isUndefined(t)?this.state.sortKey:t,i=e.isUndefined(i)?this.state.order:i,t&&i){var a=function(e,a){var r,o=e.get(t),s=a.get(t);return 1===i&&(r=o,o=s,s=r),o===s?0:s>o?-1:1};return a}}});return i});
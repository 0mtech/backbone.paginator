/*
  backbone-pageable
  http://github.com/wyuenho/backbone-pageable

  Copyright (c) 2012 Jimmy Yuen Ho Wong
  Licensed under the MIT @license.
*/
(function(e){if("object"==typeof exports)module.exports=e(require("underscore"),require("backbone"));else if("function"==typeof define&&define.amd)define(["underscore","backbone"],e);else if("undefined"!=typeof _&&"undefined"!=typeof Backbone){var t=Backbone.PageableCollection,i=Backbone.PageableCollection=e(_,Backbone);Backbone.PageableCollection.noConflict=function(){return Backbone.PageableCollection=t,i}}})(function(e,t){"use strict";function i(t,i){if(!e.isNumber(t)||e.isNaN(t)||!e.isFinite(t)||~~t!==t)throw new TypeError("`"+i+"` must be a finite integer, but was '"+t+"'");return t}var r=/[\s'"]/g,s=/[<>\s'"]/g,a=t.Collection.extend({state:{firstPage:1,lastPage:null,currentPage:null,pageSize:25,totalPages:null,totalRecords:null,sortKey:null,order:-1},mode:"server",queryParams:{currentPage:"page",pageSize:"per_page",totalPages:"total_pages",totalRecords:"total_entries",sortKey:"sort_by",order:"order",directions:{"-1":"asc",1:"desc"}},initialize:function(t,i){i=i||{};var r=i.mode||this.mode||n.mode;if(!e.contains(["server","client","infinite"],r))throw new TypeError('`mode` must be one of "server", "client" or "infinite"');this.mode=r;var s=e.extend({},n.queryParams,this.queryParams,i.queryParams||{});s.directions=e.extend({},n.queryParams.directions,this.queryParams.directions,s.directions||{}),this.queryParams=s;var a=this.state=e.extend({},n.state,this.state,i.state||{});if(a.currentPage=null==a.currentPage?a.firstPage:a.currentPage,this.switchMode(r,e.extend({fetch:!1,models:t},i)),"client"==r){null!=a.totalRecords||e.isEmpty(t)||(a.totalRecords=t.length);var o=i.comparator;if(a.sortKey&&!o&&(o=this.makeComparator(a.sortKey,a.order,i)),o)if(i.full){var l=this.fullCollection;l.comparator=o,l.sort()}else this.comparator=o;t&&!e.isEmpty(t)&&(this.getPage(a.currentPage),t.splice.apply(t,[0,t.length].concat(this.models)))}this.state=this._checkState(a)},_makeFullCollection:function(i,r){var s,a,n,o=["url","model","sync","comparator"],l=this.constructor.prototype,c={};for(s=0,a=o.length;a>s;s++)n=o[s],e.isUndefined(l[n])||(c[n]=l[n]);var u=new(t.Collection.extend(c))(i,r),h=this;for(s=0,a=o.length;a>s;s++)n=o[s],h[n]!==l[n]&&(u[n]=n);return u._onFullCollectionEvent=this._onFullCollectionEvent,u.on("all",u._onFullCollectionEvent,u),u.pageableCollection=this,u},_resetQuickly:function(){var t=arguments[0],i=e.toArray(arguments).slice(1),r=t.comparator;t.comparator=null;try{t.reset.apply(t,i)}finally{t.comparator=r,r&&t.sort()}return t},_onPageableCollectionEvent:function(t,i,r,s){var a=this.fullCollection;this.off("all",this._onPageableCollectionEvent,this),a.off("all",a._onFullCollectionEvent,a);var n=this.state,o=0===n.firstPage?n.currentPage:n.currentPage-1,l=n.pageSize,c=o*l,u=c+l;if("add"==t){var h=c+this.indexOf(i);a.add(i,e.extend({},s||{},{at:h})),this.pop()}if("remove"==t){var f=a.at(u);f&&this.push(f),a.remove(i)}if("reset"==t){s=r,r=i,i=null;var g=a.models.slice(0,c),d=a.models.slice(c+this.models.length);this._resetQuickly(a,g.concat(this.models).concat(d)),this._resetQuickly(this,a.models.slice(c,u),{silent:!0})}a.on("all",a._onFullCollectionEvent,a),this.on("all",this._onPageableCollectionEvent,this)},_onFullCollectionEvent:function(t,i,r,s){var a=this.pageableCollection;this.off("all",this._onFullCollectionEvent,this),a.off("all",a._onPageableCollectionEvent,a);var n=a.state,o=0===n.firstPage?n.currentPage:n.currentPage-1,l=n.pageSize,c=o*l,u=c+l;if("add"==t){var h=this.indexOf(i);if(h>=c&&u>h){var f=h-c;a.pop(),a.add(i,e.extend({},s||{},{at:f}))}}if("remove"==t&&s.index>=c&&u>s.index){a.remove(i);var g=this.at(u);g&&a.push(g)}if("reset"==t||"sort"==t){if(s=r,r=i,"client"==a.mode){var d=e.extend({},n,{lastPage:null,totalPages:null,totalRecords:this.models.length});a.state=a._checkState(d)}a._resetQuickly(a,this.models.slice(c,u),s)}a.on("all",a._onPageableCollectionEvent,a),this.on("all",this._onFullCollectionEvent,this)},_checkState:function(e){var t=e.totalRecords,r=e.pageSize,s=e.currentPage,a=e.firstPage,n=e.totalPages;if(null!=t&&null!=r&&null!=s&&null!=a){if(i(t,"totalRecords"),i(r,"pageSize"),i(s,"currentPage"),i(a,"firstPage"),1>r||r>t)throw new RangeError("`pageSize` must be 1 <= pageSize <= totalRecords");if(null==n&&(n=e.totalPages=Math.ceil(t/r)),0===a){if(a>s||s>=n)throw new RangeError("`currentPage` must be firstPage <= currentPage < totalPages if 0-based.")}else{if(1!==a)throw new RangeError("`firstPage must be 0 or 1`");if(a>s||s>n)throw new RangeError("`currentPage` must be firstPage <= currentPage <= totalPages if 1-based.")}e.lastPage=0===a?n-1:n}return e},setPageSize:function(t,r){return i(t,"pageSize"),r=r||{},this.state=this._checkState(e.extend({},this.state,{pageSize:t,totalPages:"client"==this.mode?Math.ceil(this.fullCollection.size()/t):Math.ceil(this.state.totalRecords/t)})),this.getPage(this.state.currentPage,r)},switchMode:function(t,i){i=i||{};var r;return this.state=this._checkState(e.extend({},this.state)),"client"==t?(this.links&&delete this.links,r=this.fullCollection=this._makeFullCollection(i.models||[]),r.comparator=this._fullComparator,this.on("all",this._onPageableCollectionEvent,this)):this.fullCollection&&(r=this.fullCollection,r.off("all",r._onFullCollectionEvent,r),this.off("all",this._onPageableCollectionEvent,this),this._fullComparator=r.comparator,delete this.fullCollection,"server"==t&&this.links&&delete this.links),"infinite"==t&&(this.links={first:this.url,next:this.url}),null==i.fetch||i.fetch?this.fetch(i):this},getFirstPage:function(e){return this.getPage("first",e)},getPreviousPage:function(e){return this.getPage("prev",e)},getNextPage:function(e){return this.getPage("next",e)},getLastPage:function(e){return this.getPage("last",e)},getPage:function(t,r){r=r||{fetch:!1};var s=this,a=this.links;if("infinite"==this.mode){if(!a[t])throw new TypeError("No link found for '"+t+"'");return this.fetch(e.extend({url:this.links[t]},r)).done(function(e,t,i){s.links=s.parseLinks(e,i)})}var n=this.state,o=n.firstPage,l=n.currentPage,c=n.lastPage,u=n.pageSize;switch(t){case"first":t=o;break;case"prev":t=l-1;break;case"next":t=l+1;break;case"last":t=c;break;default:i(t,"index")}if(this.state=this._checkState(e.extend({},n,{currentPage:t})),"client"==this.mode&&!r.fetch){var h=(0===o?t:t-1)*u,f=h+u;return this.reset(this.fullCollection.models.slice(h,f))}return this.fetch(r,"fetch")},parseLinks:function(t,i){var a=i.getResponseHeader("Link"),n=["first","prev","previous","next","last"],o={};return e.each(a.split(","),function(t){var i=t.split(";"),a=i[0].replace(s,""),l=i.slice(1);e.each(l,function(t){var i=t.split("="),s=i[0].replace(r,""),l=i[1].replace(r,"");"rel"==s&&e.contains(n,l)&&("previous"==l?o.prev=a:o[l]=a)})}),o},parse:function(t){if(!e.isArray(t))return new TypeError("The server response must be an array");if(2===t.length&&e.isObject(t[0])&&e.isArray(t[1])){var i=this.queryParams,r=e.clone(this.state),s=t[0];return e.each(e.pairs(e.omit(i,"directions")),function(e){var t=e[0],i=e[1];r[t]=s[i]}),s.order&&(r.order=1*e.invert(i.directions)[s.order]),this.state=this._checkState(r),t[1]}return t},fetch:function(i){i=i||{};var r=i.data=i.data||{};if("infinite"==this.mode&&!i.url)return this.getNextPage();var s=this.state;this._checkState(s);var a,o,l,c,u="client"==this.mode?e.pick(this.queryParams,"sortKey","order"):e.omit(e.pick(this.queryParams,e.keys(n.queryParams)),"directions"),h=e.pairs(u),f=e.clone(this);for(a=0;h.length>a;a++)o=h[a],l=o[0],c=o[1],c=e.isFunction(c)?c.call(f):c,null!=s[l]&&null!=c&&(r[c]=s[l]);s.sortKey&&s.order?r[u.order]=this.queryParams.directions[s.order+""]:s.sortKey||delete r[u.order];var g=e.pairs(e.omit(this.queryParams,e.keys(n.queryParams)));for(a=0;g.length>a;a++)o=g[a],c=o[1],c=e.isFunction(c)?c.call(f):c,r[o[0]]=c;var d=t.Collection.prototype;if("client"==this.mode){var p=this,P=i.success;return i.success=function(e,t,r){r=r||{},r.silent=i.silent,p.fullCollection.reset(e.models,r),P&&P(e,t,r)},d.fetch.call(this,e.extend({},i,{silent:!0}))}return d.fetch.call(this,i)},makeComparator:function(e,t){if(e=null==e?this.state.sortKey:e,t=null==t?this.state.order:t,e&&t){var i=function(i,r){var s,a=i.get(e),n=r.get(e);return 1===t&&(s=a,a=n,n=s),a===n?0:n>a?-1:1};return i}}}),n=a.prototype;return a});
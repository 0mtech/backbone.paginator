/*
  backbone-pageable
  http://github.com/wyuenho/backbone-pageable

  Copyright (c) 2012 Jimmy Yuen Ho Wong
  Licensed under the MIT @license.
*/
(function(e){if("object"==typeof exports)module.exports=e(require("underscore"),require("backbone"));else if("function"==typeof define&&define.amd)define(["underscore","backbone"],e);else if("undefined"!=typeof _&&"undefined"!=typeof Backbone){var t=Backbone.PageableCollection,r=Backbone.PageableCollection=e(_,Backbone);Backbone.PageableCollection.noConflict=function(){return Backbone.PageableCollection=t,r}}})(function(e,t){"use strict";function r(t,r){if(!e.isNumber(t)||e.isNaN(t)||!e.isFinite(t)||~~t!==t)throw new TypeError("`"+r+"` must be a finite integer, but was '"+t+"'");return t}var i=t.Collection.extend({state:{firstPage:1,lastPage:null,currentPage:null,pageSize:25,totalPages:null,totalRecords:null,sortKey:null,order:-1},mode:"server",queryParams:{currentPage:"page",pageSize:"per_page",totalPages:"total_pages",totalRecords:"total_entries",sortKey:"sort_by",order:"order",directions:{"-1":"asc",1:"desc"}},fullCollection:void 0,initialize:function(t,r){r=r||{};var i=r.mode||this.mode||a.mode;if(!e.contains(["server","client","infinite"],i))throw new TypeError('`mode` must be one of "server", "client" or "infinite"');this.mode=i;var s=e.extend({},a.queryParams,this.queryParams,r.queryParams||{});s.directions=e.extend({},a.queryParams.directions,this.queryParams.directions,s.directions||{}),this.queryParams=s;var n=this.state=e.extend({},a.state,this.state,r.state||{});if(n.currentPage=null==n.currentPage?n.firstPage:n.currentPage,"client"==this.mode){null==n.totalRecords&&t&&!e.isEmpty(t)&&(n.totalRecords=t.length),this.state=this._checkState(n);var o=this.fullCollection=this._makeFullCollection(t,e.omit(r,"comparator","state","queryParams")),l=r.comparator;e.isString(n.sortKey)&&!e.isFunction(l)&&(l=this.makeComparator(n.sortKey,n.order,r)),r.full?(o.comparator=l,o.sort()):this.comparator=l,t&&!e.isEmpty(t)&&(this.getPage(n.currentPage),t.splice.apply(t,[0,t.length].concat(this.models))),this.on("all",this._onPageableCollectionEvent,this)}else this.state=this._checkState(n)},_makeFullCollection:function(r,i){var a,s,n,o=["url","model","sync","comparator"],l=this.constructor.prototype,c={};for(a=0,s=o.length;s>a;a++)n=o[a],e.isUndefined(l[n])||(c[n]=l[n]);var u=new(t.Collection.extend(c))(r,i),h=this;for(a=0,s=o.length;s>a;a++)n=o[a],h[n]!==l[n]&&(u[n]=n);return u._onFullCollectionEvent=this._onFullCollectionEvent,u.on("all",u._onFullCollectionEvent,u),u.pageableCollection=this,u},_resetQuickly:function(){var t=arguments[0],r=e.toArray(arguments).slice(1),i=t.comparator;t.comparator=null;try{t.reset.apply(t,r)}finally{t.comparator=i,i&&t.sort()}return t},_onPageableCollectionEvent:function(t,r,i,a){var s=this.fullCollection;this.off("all",this._onPageableCollectionEvent,this),s.off("all",s._onFullCollectionEvent,s);var n=this.state,o=0===n.firstPage?n.currentPage:n.currentPage-1,l=n.pageSize,c=o*l,u=c+l;if("add"==t){var h=c+this.indexOf(r);s.add(r,e.extend({},a||{},{at:h})),this.pop()}if("remove"==t){var f=s.at(u);f&&this.push(f),s.remove(r)}if("reset"==t){a=i,i=r,r=null;var g=s.models.slice(0,c),d=s.models.slice(c+this.models.length);this._resetQuickly(s,g.concat(this.models).concat(d)),this._resetQuickly(this,s.models.slice(c,u),{silent:!0})}s.on("all",s._onFullCollectionEvent,s),this.on("all",this._onPageableCollectionEvent,this)},_onFullCollectionEvent:function(t,r,i,a){var s=this.pageableCollection;this.off("all",this._onFullCollectionEvent,this),s.off("all",s._onPageableCollectionEvent,s);var n=s.state,o=0===n.firstPage?n.currentPage:n.currentPage-1,l=n.pageSize,c=o*l,u=c+l;if("add"==t){var h=this.indexOf(r);if(h>=c&&u>h){var f=h-c;s.pop(),s.add(r,e.extend({},a||{},{at:f}))}}if("remove"==t&&a.index>=c&&u>a.index){s.remove(r);var g=this.at(u);g&&s.push(g)}if("reset"==t||"sort"==t){if(a=i,i=r,"client"==s.mode){var d=e.extend({},n,{lastPage:null,totalPages:null,totalRecords:this.models.length});s.state=s._checkState(d)}s._resetQuickly(s,this.models.slice(c,u),a)}s.on("all",s._onPageableCollectionEvent,s),this.on("all",this._onFullCollectionEvent,this)},_checkState:function(e){if(null!=e.totalRecords&&null!=e.pageSize&&null!=e.currentPage&&null!=e.firstPage){if(r(e.totalRecords,"totalRecords"),r(e.pageSize,"pageSize"),r(e.currentPage,"currentPage"),r(e.firstPage,"firstPage"),1>e.pageSize||e.pageSize>e.totalRecords)throw new RangeError("`pageSize` must be 1 <= pageSize <= totalRecords");if(null==e.totalPages&&(e.totalPages=Math.ceil(e.totalRecords/e.pageSize)),0===e.firstPage){if(e.currentPage<e.firstPage||e.currentPage>=e.totalPages)throw new RangeError("`currentPage` must be firstPage <= currentPage < totalPages if 0-based.")}else{if(1!==e.firstPage)throw new RangeError("`firstPage must be 0 or 1`");if(e.currentPage<e.firstPage||e.currentPage>e.totalPages)throw new RangeError("`currentPage` must be firstPage <= currentPage <= totalPages if 1-based.")}e.lastPage=0===e.firstPage?e.totalPages-1:e.totalPages}return e},setPageSize:function(t,i){return r(t,"pageSize"),i=i||{},this.state=this._checkState(e.extend({},this.state,{pageSize:t,totalPages:"client"==this.mode?Math.ceil(this.fullCollection.size()/t):Math.ceil(this.state.totalRecords/t)})),this.getPage(this.state.currentPage,i)},switchMode:function(t,r){var i;return this.state=this._checkState(e.extend({},this.state,{mode:t})),"server"==t||"infinite"==t&&this.fullCollection?(i=this.fullCollection,i.off("all",i._onFullCollectionEvent,i),this.off("all",this._onPageableCollectionEvent,this),this._fullComparator=i.comparator,delete this.fullCollection,"server"==t&&this.links&&delete this.links):"client"==t&&(this.links&&delete this.links,i=this.fullCollection=this._makeFullCollection([]),i.comparator=this._fullComparator,this.on("all",this._onPageableCollectionEvent,this)),r&&e.isBoolean(r.fetch)&&!r.fetch?this:this.fetch(r)},getFirstPage:function(e){return this.getPage("first",e)},getPreviousPage:function(e){return this.getPage("prev",e)},getNextPage:function(e){return this.getPage("next",e)},getLastPage:function(e){return this.getPage("last",e)},getPage:function(t,i){i=i||{fetch:!1};var a=this;if("infinite"==this.mode)return this.fetch(e.extend({url:this.links[t]},i)).done(function(e,t,r){a.links=a.parseLinks(e,r)});if(e.isString(t))switch(t){case"first":t=this.state.firstPage;break;case"prev":t=this.state.currentPage-1;break;case"next":t=this.state.currentPage+1;break;case"last":t=this.state.lastPage;break;default:throw new TypeError('If `index` is a string, it must be one of "first", "prev", "next" or "last"')}else r(t,"index");if(this.state.firstPage>t||t>this.state.lastPage)throw new RangeError("`index` must be firstPage <= index <= lastPage");var s=this.state=this._checkState(e.extend({},this.state,{currentPage:t}));if("client"==this.mode&&!i.fetch){var n=(0===s.firstPage?s.currentPage:s.currentPage-1)*s.pageSize,o=n+s.pageSize;return this.reset(this.fullCollection.models.slice(n,o))}return this.fetch(e.omit(i,"fetch"))},PARAM_TRIM_RE:/[\s'"]/g,URL_TRIM_RE:/[<>\s'"]/g,parseLinks:function(t,r){var i=this,a=r.getResponseHeader("Link"),s=["first","prev","previous","next","last"],n={};return e.each(a.split(","),function(t){var r=t.split(";"),a=r[0].replace(i.URL_TRIM_RE,""),o=r.slice(1);e.each(o,function(t){var r=t.split("="),o=r[0].replace(i.PARAM_TRIM_RE,""),l=r[1].replace(i.PARAM_TRIM_RE,"");"rel"==o&&e.contains(s,l)&&("previous"==l?n.prev=a:n[l]=a)})}),n},parse:function(t){if(!e.isArray(t))return new TypeError("The server response must be an array");if(2===t.length&&e.isObject(t[0])&&e.isArray(t[1])){var r=e.clone(this.state),i=t[0];return e.each(e.pairs(e.omit(this.queryParams,"directions")),function(e){var t=e[0],a=e[1];r[t]=i[a]}),i.order&&(r.order=1*e.invert(this.queryParams.directions)[i.order]),this.state=this._checkState(r),t[1]}return t},fetch:function(r){r=r||{};var i=r.data=r.data||{},s=this.state;this._checkState(s);var n,o,l,c,u="client"==this.mode?e.pick(this.queryParams,"sortKey","order"):e.omit(e.pick(this.queryParams,e.keys(a.queryParams)),"directions"),h=e.pairs(u);for(n=0;h.length>n;n++)o=h[n],l=o[0],c=e.result(o,1),null!=s[l]&&null!=c&&(i[c]=s[l]);s.sortKey&&s.order?i[u.order]=this.queryParams.directions[s.order+""]:s.sortKey||delete i[u.order];var f=e.pairs(e.omit(this.queryParams,e.keys(a.queryParams)));for(n=0;f.length>n;n++)o=f[n],i[o[0]]=e.result(o,1);var g=t.Collection.prototype;if("client"==this.mode){var d=this,P=r.success;return r.success=function(e,t,i){i=i||{},i.silent=r.silent,d.fullCollection.reset(e.models,i),P&&P(e,t,i)},g.fetch.call(this,e.extend({},r,{silent:!0}))}return g.fetch.call(this,r)},makeComparator:function(t,r){if(t=e.isUndefined(t)?this.state.sortKey:t,r=e.isUndefined(r)?this.state.order:r,t&&r){var i=function(e,i){var a,s=e.get(t),n=i.get(t);return 1===r&&(a=s,s=n,n=a),s===n?0:n>s?-1:1};return i}}}),a=i.prototype;return i});